<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan de Restructuration d'Entrepôt Interactif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }
        .tab-btn {
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            color: #2563eb;
            border-color: #2563eb;
            background-color: #eff6ff;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 350px;
            padding-bottom: 50%; /* Maintenir le ratio pour responsive */
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 320px;
                padding-bottom: 0; /* Désactiver le padding sur desktop si hauteur fixe */
            }
        }
        .technique-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .technique-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .raci-table th, .raci-table td {
            transition: background-color 0.2s ease-in-out;
        }
        .raci-table .highlight {
            background-color: #dbeafe;
        }
        .warehouse-diagram-box {
            border: 2px solid #9ca3af;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #6366f1;
            animation: spin 1s ease infinite;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style spécifique pour le contenu Markdown généré */
        #questions-output p, #role-desc-output p, #comm-plan-output p {
            margin-bottom: 1em; /* Espace entre les paragraphes */
        }
        #questions-output ol, #role-desc-output ol, #comm-plan-output ol,
        #questions-output ul, #role-desc-output ul, #comm-plan-output ul {
            margin-left: 1.5em; /* Retrait pour les listes */
            padding-left: 0;
            list-style-type: decimal;
        }
        #questions-output li, #role-desc-output li, #comm-plan-output li {
            margin-bottom: 0.5em; /* Espace entre les items de liste */
        }
        /* Ajout d'une police plus moderne pour les balises générées */
        #questions-output strong, #role-desc-output strong, #comm-plan-output strong {
             font-weight: 700; /* Assurer que le gras est bien visible */
             color: #1e293b;
        }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800">Plan de Restructuration d'Entrepôt</h1>
            <p class="mt-2 text-lg text-slate-600">Un guide interactif pour réimaginer vos opérations d'entrepôt.</p>
             <p class="mt-4 text-sm font-medium text-red-600 border border-red-300 bg-red-50 p-3 rounded-lg">
                Les appels API passent par une fonction Netlify sécurisée. **Assurez-vous que le fichier <code>gemini-proxy.js</code> est bien déployé** sur Netlify pour que les fonctionnalités IA fonctionnent.
            </p>
        </header>

        <nav class="mb-8">
            <div class="flex flex-col sm:flex-row justify-center border-b border-slate-300">
                <button data-target="intro" class="tab-btn active text-slate-600 font-semibold py-3 px-6 border-b-2 border-transparent hover:bg-slate-100">Introduction</button>
                <button data-target="phase1" class="tab-btn text-slate-600 font-semibold py-3 px-6 border-b-2 border-transparent hover:bg-slate-100">Phase 1: État Actuel</button>
                <button data-target="phase2" class="tab-btn text-slate-600 font-semibold py-3 px-6 border-b-2 border-transparent hover:bg-slate-100">Phase 2: État Futur</button>
                <button data-target="phase3" class="tab-btn text-slate-600 font-semibold py-3 px-6 border-b-2 border-transparent hover:bg-slate-100">Phase 3: Implémentation</button>
            </div>
        </nav>

        <main>
            <section id="intro" class="content-section active p-4 md:p-6 bg-white rounded-lg shadow-sm">
                <h2 class="text-2xl font-bold mb-4 text-slate-700">Objectif et Introduction du Projet</h2>
                <p class="text-slate-600 leading-relaxed">
                    Bienvenue dans le guide interactif de restructuration de vos équipes de gestion des stocks et d'entrepôt. L'objectif principal est de repenser la distribution des processus et des rôles pour optimiser l'efficacité et la responsabilisation dans toutes vos installations. Utilisez les onglets ci-dessus pour naviguer entre les trois phases structurées de l'analyse.
                </p>
                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-4 text-slate-700">Aperçu de l'Entrepôt</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="warehouse-diagram-box">
                            <h4 class="font-bold text-lg">Entrepôt 1</h4>
                            <p class="text-slate-500">Matières Premières</p>
                            <div class="mt-4 space-y-2">
                                <span class="inline-block bg-blue-100 text-blue-800 text-sm font-medium mr-2 px-2.5 py-0.5 rounded-full">Accessoires de Cuisine</span>
                                <span class="inline-block bg-green-100 text-green-800 text-sm font-medium mr-2 px-2.5 py-0.5 rounded-full">Panneaux MDF</span>
                            </div>
                        </div>
                        <div class="warehouse-diagram-box">
                            <h4 class="font-bold text-lg">Entrepôt 2</h4>
                            <p class="text-slate-500">Appareils et Produits Finis</p>
                            <div class="mt-4 space-y-2">
                                <span class="inline-block bg-purple-100 text-purple-800 text-sm font-medium mr-2 px-2.5 py-0.5 rounded-full">Appareils de Cuisine</span>
                                <span class="inline-block bg-yellow-100 text-yellow-800 text-sm font-medium mr-2 px-2.5 py-0.5 rounded-full">Produits Finis</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="phase1" class="content-section p-4 md:p-6 bg-white rounded-lg shadow-sm">
                <h2 class="text-2xl font-bold mb-2 text-slate-700">Phase 1: Analyse de l'État Actuel (As-Is)</h2>
                <p class="mb-6 text-slate-600">Avant de concevoir l'avenir, il faut comprendre le présent. Cette phase se concentre sur la cartographie des processus existants et l'identification des rôles actuels.</p>
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="technique-card bg-slate-50 p-6 rounded-lg border border-slate-200">
                        <h3 class="font-bold text-lg mb-2 text-blue-700">Cartographie des Processus</h3>
                        <p class="text-slate-600">Créez des diagrammes visuels de vos flux de travail entrants et sortants pour identifier les goulots d'étranglement.</p>
                    </div>
                    <div class="technique-card bg-slate-50 p-6 rounded-lg border border-slate-200">
                        <h3 class="font-bold text-lg mb-2 text-blue-700">Entretiens avec les Parties Prenantes</h3>
                        <p class="text-slate-600">Menez des entretiens avec les membres clés de l'équipe (managers, commis, chefs d'équipe) pour recueillir des informations qualitatives.</p>
                    </div>
                    <div class="technique-card bg-slate-50 p-6 rounded-lg border border-slate-200">
                        <h3 class="font-bold text-lg mb-2 text-blue-700">Analyse Documentaire</h3>
                        <p class="text-slate-600">Examinez les descriptions de rôle et les Procédures Opérationnelles Standard (POS) existantes.</p>
                    </div>
                </div>
                <div class="mt-8 p-6 bg-slate-50 rounded-lg border border-slate-200">
                    <h3 class="font-bold text-lg mb-2 text-slate-700">✨ Assistant de Questions d'Entrevue</h3>
                    <p class="text-slate-600 text-sm mb-4">Obtenez une liste d'exemples de questions pour un rôle spécifique afin de faciliter vos entretiens.</p>
                    <textarea id="interview-role-input" class="w-full h-24 p-2 mb-4 rounded-lg border border-slate-300 text-sm" placeholder="Ex. : Commis d'entrepôt ou Gestionnaire des stocks"></textarea>
                    <button id="generate-questions-btn" class="flex items-center justify-center w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Générer des Questions ✨
                        <div id="questions-loading" class="loading-spinner ml-2"></div>
                    </button>
                    <div id="questions-output" class="mt-4 p-4 bg-white rounded-lg border border-slate-200 text-sm whitespace-pre-wrap leading-relaxed"></div>
                </div>
            </section>

            <section id="phase2" class="content-section p-4 md:p-6 bg-white rounded-lg shadow-sm">
                <h2 class="text-2xl font-bold mb-2 text-slate-700">Phase 2: Définition de l'État Futur (To-Be)</h2>
                <p class="mb-6 text-slate-600">À l'aide des analyses précédentes, cette phase définit la nouvelle structure optimisée, en définissant des rôles clairs pour rationaliser les opérations.</p>
                <div class="grid lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-slate-700">Techniques de Modélisation Clés</h3>
                        <div class="space-y-4">
                            <div class="technique-card bg-slate-50 p-4 rounded-lg border border-slate-200">
                                <h4 class="font-bold text-md text-blue-700">Ateliers d'Exigences</h4>
                                <p class="text-slate-600 text-sm">Réunir les parties prenantes pour s'entendre sur les fonctions de base et les compétences requises dans la nouvelle structure.</p>
                            </div>
                            <div class="technique-card bg-slate-50 p-4 rounded-lg border border-slate-200">
                                <h4 class="font-bold text-md text-blue-700">Définition des Rôles</h4>
                                <p class="text-slate-600 text-sm">Définir les nouveaux rôles et documenter leur objectif, leurs responsabilités et leurs compétences nécessaires.</p>
                            </div>
                            <div class="technique-card bg-slate-50 p-4 rounded-lg border border-slate-200">
                                <h4 class="font-bold text-md text-blue-700">Analyse de la Charge de Travail</h4>
                                <p class="text-slate-600 text-sm">Estimer le volume d'activités pour chaque nouveau rôle afin d'assurer un équilibre du travail.</p>
                            </div>
                        </div>
                         <div class="mt-6">
                            <h3 class="text-xl font-semibold mb-4 text-slate-700">Exemple : Analyse de la Charge</h3>
                            <div class="chart-container h-64 md:h-72">
                                <canvas id="workloadChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-slate-700">Exemple : Matrice RACI</h3>
                        <p class="text-slate-500 mb-4 text-sm">Passez la souris sur une tâche pour voir les responsabilités. (Responsible, Accountable, Consulted, Informed).</p>
                        <div class="overflow-x-auto">
                            <table class="raci-table w-full text-left border-collapse">
                                <thead>
                                    <tr>
                                        <th class="p-3 font-semibold uppercase bg-slate-100 border border-slate-300">Processus / Tâche</th>
                                        <th class="p-3 font-semibold uppercase bg-slate-100 border border-slate-300">Spécialiste Entrant</th>
                                        <th class="p-3 font-semibold uppercase bg-slate-100 border border-slate-300">Coordonnateur Expédition</th>
                                        <th class="p-3 font-semibold uppercase bg-slate-100 border border-slate-300">Gestionnaire Entrepôt</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="hover:bg-slate-50">
                                        <td class="p-3 font-semibold border border-slate-200">Réception Marchandises (MDF)</td>
                                        <td class="p-3 border border-slate-200">Responsible</td>
                                        <td class="p-3 border border-slate-200">Informed</td>
                                        <td class="p-3 border border-slate-200">Accountable, Consulted</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="p-3 font-semibold border border-slate-200">Comptage d'Inventaire</td>
                                        <td class="p-3 border border-slate-200">Responsible</td>
                                        <td class="p-3 border border-slate-200">Consulted</td>
                                        <td class="p-3 border border-slate-200">Accountable</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="p-3 font-semibold border border-slate-200">Préparation Commandes</td>
                                        <td class="p-3 border border-slate-200">Informed</td>
                                        <td class="p-3 border border-slate-200">Responsible</td>
                                        <td class="p-3 border border-slate-200">Accountable, Consulted</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="p-3 border border-slate-200">Contrôle Qualité</td>
                                        <td class="p-3 border border-slate-200">Responsible</td>
                                        <td class="p-3 border border-slate-200">Responsible</td>
                                        <td class="p-3 border border-slate-200">Accountable</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="mt-8 p-6 bg-slate-50 rounded-lg border border-slate-200">
                    <h3 class="font-bold text-lg mb-2 text-slate-700">✨ Assistant de Description de Rôle</h3>
                    <p class="text-slate-600 text-sm mb-4">Entrez un nouveau titre de rôle et quelques responsabilités clés pour générer une description complète.</p>
                    <textarea id="role-desc-input" class="w-full h-24 p-2 mb-4 rounded-lg border border-slate-300 text-sm" placeholder="Ex. : Gestionnaire de la logistique entrante, supervision des stocks et du personnel."></textarea>
                    <button id="generate-role-desc-btn" class="flex items-center justify-center w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Générer Description de Rôle ✨
                        <div id="role-desc-loading" class="loading-spinner ml-2"></div>
                    </button>
                    <div id="role-desc-output" class="mt-4 p-4 bg-white rounded-lg border border-slate-200 text-sm whitespace-pre-wrap leading-relaxed"></div>
                </div>
            </section>

            <section id="phase3" class="content-section p-4 md:p-6 bg-white rounded-lg shadow-sm">
                <h2 class="text-2xl font-bold mb-2 text-slate-700">Phase 3: Implémentation et Suivi</h2>
                <p class="mb-6 text-slate-600">Cette phase se concentre sur la gestion de la transition et l'établissement de métriques pour mesurer le succès. Une bonne exécution est la clé.</p>
                <div class="grid lg:grid-cols-2 gap-8 items-start">
                     <div>
                        <h3 class="text-xl font-semibold mb-4 text-slate-700">Techniques d'Implémentation</h3>
                        <div class="space-y-4">
                           <div class="technique-card bg-slate-50 p-6 rounded-lg border border-slate-200">
                                <h3 class="font-bold text-lg mb-2 text-blue-700">Plan de Communication</h3>
                                <p class="text-slate-600">Élaborez une stratégie claire pour communiquer les changements à toute l'équipe, expliquant la raison d'être et les avantages.</p>
                            </div>
                            <div class="technique-card bg-slate-50 p-6 rounded-lg border border-slate-200">
                                <h3 class="font-bold text-lg mb-2 text-blue-700">Plan de Formation</h3>
                                <p class="text-slate-600">Créez et offrez des sessions de formation pour doter les membres de l'équipe des compétences nécessaires à leurs nouveaux rôles.</p>
                            </div>
                        </div>
                    </div>
                    <div>
                         <h3 class="text-xl font-semibold mb-4 text-slate-700">Tableau de Bord des Métriques</h3>
                         <p class="text-slate-500 mb-4 text-sm">Établissez des indicateurs de performance clés (KPI) pour mesurer le succès de la restructuration.</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-center">
                                <h4 class="font-semibold text-slate-700">Précision des Stocks</h4>
                                <div class="chart-container h-48 sm:h-56">
                                    <canvas id="accuracyChart"></canvas>
                                </div>
                            </div>
                             <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-center">
                                <h4 class="font-semibold text-slate-700">Temps de Cycle de Commande (Jours)</h4>
                                <div class="chart-container h-48 sm:h-56">
                                    <canvas id="cycleTimeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 p-6 bg-slate-50 rounded-lg border border-slate-200">
                    <h3 class="font-bold text-lg mb-2 text-slate-700">✨ Assistant de Communication</h3>
                    <p class="text-slate-600 text-sm mb-4">Rédigez un message clair et professionnel pour annoncer les changements à l'équipe.</p>
                    <textarea id="comm-plan-input" class="w-full h-24 p-2 mb-4 rounded-lg border border-slate-300 text-sm" placeholder="Ex. : Expliquer les nouveaux rôles et l'amélioration de l'efficacité. Public : Tout le personnel d'entrepôt."></textarea>
                    <button id="generate-comm-plan-btn" class="flex items-center justify-center w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Rédiger le Plan de Communication ✨
                        <div id="comm-plan-loading" class="loading-spinner ml-2"></div>
                    </button>
                    <div id="comm-plan-output" class="mt-4 p-4 bg-white rounded-lg border border-slate-200 text-sm whitespace-pre-wrap leading-relaxed"></div>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tabs = document.querySelectorAll('.tab-btn');
            const contentSections = document.querySelectorAll('.content-section');

            // ⚠️ ADRESSE NETLIFY AJOUTÉE (si l'appel proxy direct échoue)
            const netlifyDomain = 'https://effortless-kulfi-52a95b.netlify.app';
            // Le PROXY_ENDPOINT tente d'abord le chemin relatif (meilleure pratique)
            let PROXY_ENDPOINT = '/.netlify/functions/gemini-proxy';
            
            // Si le déploiement Netlify n'utilise pas le proxy relatif, on revient au domaine codé en dur.
            if (window.location.host.includes('github.io') || window.location.host.includes('vercel.app')) {
                 PROXY_ENDPOINT = netlifyDomain + '/.netlify/functions/gemini-proxy';
            }
            // ----------------------------------------------------

            const interviewRoleInput = document.getElementById('interview-role-input');
            const generateQuestionsBtn = document.getElementById('generate-questions-btn');
            const questionsOutput = document.getElementById('questions-output');
            const questionsLoading = document.getElementById('questions-loading');

            const roleDescInput = document.getElementById('role-desc-input');
            const generateRoleDescBtn = document.getElementById('generate-role-desc-btn');
            const roleDescOutput = document.getElementById('role-desc-output');
            const roleDescLoading = document.getElementById('role-desc-loading');

            const commPlanInput = document.getElementById('comm-plan-input');
            const generateCommPlanBtn = document.getElementById('generate-comm-plan-btn');
            const commPlanOutput = document.getElementById('comm-plan-output');
            const commPlanLoading = document.getElementById('comm-plan-loading');

            const showLoading = (loader) => loader.style.display = 'block';
            const hideLoading = (loader) => loader.style.display = 'none';

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.dataset.target;
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    contentSections.forEach(section => {
                        if (section.id === target) {
                            section.classList.add('active');
                        } else {
                            section.classList.remove('active');
                        }
                    });
                });
            });

            const raciTable = document.querySelector('.raci-table');
            if(raciTable) {
                const cells = raciTable.querySelectorAll('td, th');
                cells.forEach(cell => {
                    cell.addEventListener('mouseover', () => {
                        const colIndex = cell.cellIndex;
                        const rowIndex = cell.parentElement.rowIndex;
                        const rowCells = raciTable.rows[rowIndex].cells;
                        for(let i=0; i<rowCells.length; i++) {
                            rowCells[i].classList.add('highlight');
                        }
                        for(let i=0; i<raciTable.rows.length; i++) {
                            raciTable.rows[i].cells[colIndex].classList.add('highlight');
                        }
                    });
                     cell.addEventListener('mouseout', () => {
                        cells.forEach(c => c.classList.remove('highlight'));
                    });
                });
            }

            // --- Chart Initializations (Reste inchangé) ---
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                scales: {
                     x: {
                        ticks: {
                            font: {
                                size: 10
                            },
                            autoSkip: false,
                            maxRotation: 0,
                            minRotation: 0
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                         grid: {
                            color: '#e2e8f0'
                        },
                        ticks: {
                             font: {
                                size: 10
                            }
                        }
                    }
                }
            };

            const workloadCtx = document.getElementById('workloadChart');
            if (workloadCtx) {
                new Chart(workloadCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Spécialiste Entrant', 'Coordonnateur Expédition', 'Gestionnaire Entrepôt'],
                        datasets: [{
                            label: 'Heures Hebdomadaires Estimées',
                            data: [38, 40, 35],
                            backgroundColor: ['#60a5fa', '#34d399', '#facc15'],
                            borderColor: ['#3b82f6', '#10b981', '#f59e0b'],
                            borderWidth: 1
                        }]
                    },
                    options: chartOptions
                });
            }

            const accuracyCtx = document.getElementById('accuracyChart');
            if (accuracyCtx) {
                new Chart(accuracyCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Précis', 'Erreur'],
                        datasets: [{
                            label: 'Précision des Stocks',
                            data: [98.5, 1.5],
                            backgroundColor: ['#34d399', '#f87171'],
                            hoverOffset: 4
                        }]
                    },
                     options: {
                        responsive: true,
                        maintainAspectRatio: false,
                         plugins: {
                            legend: {
                                display: false
                            },
                             tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.raw}%`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            const cycleTimeCtx = document.getElementById('cycleTimeChart');
            if (cycleTimeCtx) {
                 new Chart(cycleTimeCtx, {
                    type: 'line',
                    data: {
                        labels: ['T1', 'T2', 'T3', 'T4'],
                        datasets: [{
                            label: 'Temps de Cycle de Commande',
                            data: [2.5, 2.2, 1.9, 1.8],
                            fill: false,
                            borderColor: '#3b82f6',
                            tension: 0.1
                        }]
                    },
                    options: {
                         responsive: true,
                        maintainAspectRatio: false,
                         plugins: {
                             legend: {
                                display: false,
                            }
                         },
                         scales: {
                            y: {
                                beginAtZero: false,
                                title: { display: true, text: 'Jours' }
                            }
                         }
                    }
                });
            }

            // Fonction de conversion Markdown simple vers HTML (Gras, Listes, Paragraphes)
            const markdownToHtml = (markdown) => {
                let html = markdown || '';

                // Conversion des listes (plus robuste)
                html = html.replace(/(\n|^)(\d+\.\s.*)/g, '$1<li>$2</li>');
                html = html.replace(/((?:<li>.*<\/li>[\n\r]*)+)/g, '<ol>$1</ol>');
                html = html.replace(/<li>(\d+\.\s)(.*?)<\/li>/g, '<li>$2</li>'); // Retirer les numéros Markdown après la conversion en <li>
                
                // Conversion du gras
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                // Conversion des doubles sauts de ligne en paragraphes
                html = html.replace(/\n\n/g, '</p><p>');
                
                // Nettoyage des sauts de ligne simples
                html = html.replace(/\n/g, '<br>');

                // Encadrer le contenu restant de paragraphes si ce n'est pas déjà dans une liste
                if (!html.startsWith('<p>') && !html.startsWith('<ol>')) {
                    html = `<p>${html}</p>`;
                }
                
                // Nettoyage final des balises vides
                html = html.replace(/<p><\/p>/g, '');
                html = html.replace(/<br><\/p>/g, '</p>');
                html = html.replace(/<ol><\/p>/g, '<ol>').replace(/<\/p><ol>/g, '<ol>');
                
                return html;
            };

            // --- UPDATED API CALL FUNCTION (avec gestion de l'URL et du timeout) ---
            const callApi = async (userPrompt, outputElement, loadingElement, systemPrompt) => {
                showLoading(loadingElement);
                outputElement.innerHTML = 'Génération de contenu en cours... (Veuillez patienter, cela peut prendre jusqu\'à 30 secondes en raison du temps de réponse initial de l\'API)...';
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 secondes de timeout
                
                try {
                    const payload = { userPrompt, systemPrompt };
                    
                    const response = await fetch(PROXY_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        signal: controller.signal // Appliquer le signal de timeout
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                         const errorText = await response.text();
                         let errorMessage = `Erreur Proxy: ${response.status} ${response.statusText}`;

                         try {
                             const errorData = JSON.parse(errorText);
                             errorMessage = errorData.details || errorData.error || errorMessage;
                         } catch (e) {
                             errorMessage += `. Veuillez vérifier vos logs Netlify.`;
                         }
                         throw new Error(errorMessage);
                    }
                    
                    const result = await response.json();
                    const generatedText = result.text;
                    
                    if (generatedText) {
                        outputElement.innerHTML = markdownToHtml(generatedText);
                    } else {
                         throw new Error('Réponse vide ou mal formée reçue du proxy.');
                    }
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                         outputElement.innerHTML = '🚨 **Échec de la génération (Timeout)** : L\'API a mis plus de 30 secondes à répondre. Veuillez réessayer. Si l\'erreur persiste, votre clé API pourrait être en cause.';
                    } else {
                         outputElement.innerHTML = `🚨 **Échec de la génération** : Erreur: ${error.message}. Vérifiez votre clé API ou les logs Netlify.`;
                    }
                    console.error("Erreur Appel API:", error);

                } finally {
                    hideLoading(loadingElement);
                }
            };

            // --- Event Listeners ---

            generateQuestionsBtn.addEventListener('click', () => {
                const role = interviewRoleInput.value.trim();
                if (role) {
                    const systemPrompt = "Vous êtes un expert en analyse commerciale et en ressources humaines. Votre tâche est de générer des questions d'entrevue pertinentes pour un projet de restructuration. La réponse doit être en français et utiliser le format Markdown pour le gras et les listes.";
                    const userPrompt = `Générez une liste de questions d'entrevue pour un intervenant ayant le rôle de "${role}". Les questions doivent aider à comprendre leurs responsabilités actuelles, leurs défis et leurs idées. Présentez les questions sous forme de liste numérotée.`;
                    callApi(userPrompt, questionsOutput, questionsLoading, systemPrompt);
                } else {
                    questionsOutput.innerHTML = 'Veuillez entrer un rôle (ex. : Gestionnaire des stocks) pour générer des questions.';
                }
            });

            generateRoleDescBtn.addEventListener('click', () => {
                const description = roleDescInput.value.trim();
                if (description) {
                    const systemPrompt = "Vous êtes un expert en conception organisationnelle et RH. Votre tâche est de rédiger une description de poste détaillée et professionnelle pour un poste de gestion d'entrepôt. La réponse doit être en français et utiliser le format Markdown pour le gras.";
                    const userPrompt = `En vous basant sur cette entrée : "${description}", rédigez une description de rôle complète incluant un résumé, les responsabilités clés, les qualifications requises et la structure de reporting.`;
                    callApi(userPrompt, roleDescOutput, roleDescLoading, systemPrompt);
                } else {
                    roleDescOutput.innerHTML = 'Veuillez entrer un titre de rôle et quelques responsabilités pour générer une description.';
                }
            });

            generateCommPlanBtn.addEventListener('click', () => {
                const plan = commPlanInput.value.trim();
                if (plan) {
                    const systemPrompt = "Vous êtes un gestionnaire de communication d'entreprise. Rédigez une note de service interne professionnelle, claire et rassurante concernant les changements organisationnels. La réponse doit être en français et utiliser le format Markdown pour le gras.";
                    const userPrompt = `Rédigez une note de communication basée sur ce plan : "${plan}". Le ton doit être positif, axé sur l'avenir et les avantages pour le personnel.`;
                    callApi(userPrompt, commPlanOutput, commPlanLoading, systemPrompt);
                } else {
                    commPlanOutput.innerHTML = 'Veuillez entrer les éléments clés de votre plan de communication.';
                }
            });
        });
    </script>
</body>
</html>
